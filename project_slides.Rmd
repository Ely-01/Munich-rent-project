---
title: "Statistical Methods"
author: "E. Dariol, E. Imbalzano, W. Pasieka, M. Severi"
date: "22-01-2026"
output:
  ioslides_presentation: default
  beamer_presentation:
    theme: Rochester
    colortheme: beaver
  slidy_presentation: default
subtitle: 'Final Project - Group J: Rent Modelling in Munich'
---

<style>

/* 1. Force the slide to allow scrolling if content is too big */
slides > slide {
  overflow-y: auto !important;
}

/* 2. Force the Code Output box specifically to scroll */
pre {
  max-height: 400px !important; /* Limits height */
  overflow-y: auto !important;  /* Adds scrollbar */
  background-color: #f5f5f5;    /* Light gray background */
}

</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(gamlss.data)
data(rent99)
rent99$rentsqm <- rent99$rent / rent99$area
```


## Project Overview and Aim  | Munich Rents 1999

The `rent99` dataset contains data from a survey conducted in 1999 regarding apartment rents in Munich, Germany.

-   **Source:** `gamlss.data` R package.
-   **Sample Size:** 3,082 observations (apartments).
-   **Variables:** 9 variables regarding structural and locational housing characteristics.
-   **Goal:** Develop a statistical model to quantify the relationship between monthly rent and apartment characteristics.
    -  Response variable: monthly rent (`rent`).
    
- **Methodology**: exploratory data analysis and regression modelling.



## Variables

| Variable | Type | Description | Levels / Unit |
|:-----------------|:-----------------|:-----------------|:-----------------|
| **rent** | Numeric | Target Variable. The monthly net rent. | Currency (Euro) |
| **rentsqm** | Numeric | Monthly net rent per square meter. | `rent` / `area` |
| **area** | Numeric | Living area of the apartment. | Square meters ($m^2$) |
| **yearc** | Numeric | Year of construction. | Year (e.g., 1950, 1990) |
| **location** | Factor | Quality of the location in Munich. | 1 = Average<br>2 = Good<br>3 = Top |

## Variables (cont.)

| Variable | Type | Description | Levels / Unit |
|:-----------------|:-----------------|:-----------------|:-----------------|
| **bath** | Factor | Quality of the bathroom facilities. | 0 = Standard<br>1 = Premium |
| **kitchen** | Factor | Quality of the kitchen. | 0 = Standard<br>1 = Premium |
| **cheating** | Factor | Central heating available. | 0 = No<br>1 = Yes |
| **district** | Factor | The administrative district in Munich. | Categorical ID |

```{r load_rent99, include=FALSE}
# 1. Install the package
#install.packages("gamlss.data", repos = "http://cran.us.r-project.org")

# 2. Load the library
library(gamlss.data)

# 3. Load the specific dataset
data(rent99)

# 4. View the first few rows to verify
head(rent99)

str(rent99)
```

##  {.smaller}

```{r summary_rent99, warning=FALSE, message=FALSE, echo=FALSE}
library(knitr)
library(kableExtra)

kbl(summary(rent99), caption = "Summary of Rent99") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), 
                font_size = 12,
                full_width = TRUE)
```

-   **Housing Stock**: The data represents older properties, with construction years (yearc) ranging from 1918 to 1997 (Avg: 1956).

-   **Apartment Size**: Units are generally small to medium-sized, averaging \~67 sqm (max 160 sqm).

-   **Standard vs. Premium**: The vast majority of apartments fall into "standard" categories for kitchen and bath, with very few luxury outliers.

-   **Heating**: Central heating (cheating) is the norm, present in \~90% of the listed properties.



## Data Preparation and Cleaning

- Missing values:
  - no missing values detected
  - full dataset retained for analysis
- Variable type verification:
  - categorical variables treated as factors


## Preprocessing: Removing Target Leakage

- **Issue**
The variable `rentsqm` is structurally defined as the target variable divided by area:
$$\text{rentsqm} = \frac{\text{rent}}{\text{area}}$$

- **Consequence:**
Including this feature creates **Target Leakage**. It would artificially inflate goodness-of-fit metrics (leading to an unrealistic $R^2 \approx 1$), rendering the model useless for prediction.

- **Action:**
We filter out this feature to ensure valid, non-circular results.

```{r remove_rentsqm, echo=TRUE}
rent99 <- subset(rent99, select = -rentsqm)
```

# NUMERICAL VARIABLES | Univariate Analysis 

## Target Variable: `rent`

```{r rent_histogram, warning=FALSE, fig.width=5, fig.height=3, fig.align='center'}
library(ggplot2)

# Calculate statistics
mean_rent <- mean(rent99$rent, na.rm = TRUE)
median_rent <- median(rent99$rent, na.rm = TRUE)

ggplot(rent99, aes(x = rent)) +
  # Histogram: binwidth set for readability; boundary=0 aligns bars to round numbers
  geom_histogram(bins=30, fill = "steelblue", color = "white", alpha = 0.8) +
  
  # Mean line (mapped inside aes to create a legend)
  geom_vline(aes(xintercept = mean_rent, color = "Mean"), 
             linetype = "dashed", size = 1) +
  
  # Median line (mapped inside aes to create a legend)
  geom_vline(aes(xintercept = median_rent, color = "Median"), 
             linetype = "solid", size = 1) +
  
  # Custom colors and labels for the legend
  scale_color_manual(name = "Statistics", 
                     values = c("Mean" = "red", "Median" = "darkblue"),
                     labels = c(paste0("Mean: ", round(mean_rent, 1)), 
                                paste0("Median: ", round(median_rent, 1)))) +
  
  theme_minimal() +
  labs(title = "Rent Distribution (Raw)",
       x = "Monthly Rent", 
       y = "Count") +
  
  # Legend position
  theme(legend.position = "top")
```

-   **Right-Skewed**: High-value outliers pull the mean above the median

-   **Outliers**: Max value (1843) is \>4x the average

-   **Action**: `log(rent)` transformation could be taken in consideration to normalize residuals and stabilize variance

## Target Variable (cont.): `log(rent)`


```{r log_rent_histogram, warning=FALSE, fig.width=5, fig.height=3, fig.align='center'}
library(ggplot2)

rent99$log_rent <- log(rent99$rent)

# Calculate statistics for log-transformed rent
mean_log <- mean(log(rent99$rent), na.rm = TRUE)
median_log <- median(log(rent99$rent), na.rm = TRUE)

ggplot(rent99, aes(x = log(rent))) +
  # Histogram: bins=30 is usually safer for log scales than fixed binwidth
  geom_histogram(bins = 30, fill = "darkgreen", color = "white", alpha = 0.8) +
  
  # Mean line (mapped inside aes to create a legend)
  geom_vline(aes(xintercept = mean_log, color = "Mean"), 
             linetype = "dashed", size = 1) +
  
  # Median line (mapped inside aes to create a legend)
  geom_vline(aes(xintercept = median_log, color = "Median"), 
             linetype = "solid", size = 1) +
  
  # Custom colors and labels for the legend
  scale_color_manual(name = "Statistics", 
                     values = c("Mean" = "red", "Median" = "darkblue"),
                     labels = c(paste0("Mean: ", round(mean_log, 2)), 
                                paste0("Median: ", round(median_log, 2)))) +
  
  theme_minimal() +
  labs(title = "Distribution of Log(Rent)", 
       x = "Log Rent", 
       y = "Count") +
  
  # Legend position
  theme(legend.position = "top")
```

-   **Symmetry**: Distribution is now bell-shaped (normal)
-   **Alignment**: Mean $\approx$ Median; skewness eliminated
-   **Impact**: Outliers compressed and variance stabilized


## Quantitative Predictors: `area`

```{r area_histogram, warning=FALSE, fig.width=5, fig.height=3, fig.align='center'}
library(ggplot2)

# 1. Calculate Mean and Median
mean_area <- mean(rent99$area, na.rm = TRUE)
median_area <- median(rent99$area, na.rm = TRUE)

# 2. Histogram with Density, Mean, and Median (Optimized Legend)
ggplot(rent99, aes(x = area)) +
  # Histogram with density scaling
  geom_histogram(binwidth = 5, fill = "lightseagreen", color = "white", alpha = 0.8) +
  
  # Mean Line (mapped inside aes to create a legend)
  geom_vline(aes(xintercept = mean_area, color = "Mean"), 
             linetype = "dashed", size = 1) +
  
  # Median Line (mapped inside aes to create a legend)
  geom_vline(aes(xintercept = median_area, color = "Median"), 
             linetype = "solid", size = 1) +
  
  # Custom colors and labels for the legend
  scale_color_manual(name = "Statistics", 
                     values = c("Mean" = "red", "Median" = "darkblue"),
                     labels = c(paste0("Mean: ", round(mean_area, 1)), 
                                paste0("Median: ", round(median_area, 1)))) +
  
  theme_minimal() +
  labs(title = "Distribution of Apartment Size", 
       x = "Area (sqm)", 
       y = "Count") +
  
  theme(legend.position = "top")
```

-   **Well-Behaved**: Mean (67.4) $\approx$ Median (65)
-   **Stable**: No extreme outliers
-   **Range**: Covers 20–160 sqm; density concentrated at 51 sqm - 81 sqm (1st Qu - 3rd Qu)

## Quantitative Predictors: `yearc`

```{r yearc_histogram, warning=FALSE, fig.width=5, fig.height=3, fig.align='center'}
    library(ggplot2)

    # 1. Distribution of Construction Year (Histogram)
    # This shows you the "boom" periods in construction (e.g., post-war)
    plot_dist <- ggplot(rent99, aes(x = yearc)) +
      geom_histogram(binwidth = 5, fill = "orange", color = "white") +
      theme_minimal() +
      labs(title = "Distribution of Construction Years", 
           subtitle = " Peaks indicate construction booms (e.g., 1960s)",
           x = "Year of Construction", 
           y = "Count of Apartments")

    plot(plot_dist)
```

-   **Shape**: Multimodal / Irregular distribution
-   **Peaks**: Strong activity in the 1920s and 1960s
-   **Gap**: Clear construction void during WWII (\~1940s)

# NUMERICAL VARIABLES | Bivariate Analysis

## Rent vs. numerical variables

```{r area_vs_rent_scatter, warning=FALSE, message=FALSE, echo=FALSE, fig.width=3.5, fig.height=3}
library(ggplot2)

par(mfrow = c(1, 2))

ggplot(rent99, aes(x = area, y = rent)) +
  # Points with transparency
  geom_point(alpha = 0.3, color = "lightseagreen") +
  
  # Linear Regression Line
  # We map 'color' to a string identifier inside aes() to generate the legend
  geom_smooth(method = "lm", aes(color = "Linear Fit"), 
              size = 1, se = FALSE) +
  
  # Loess Line
  # We map 'color' to a string identifier inside aes()
  geom_smooth(method = "loess", aes(color = "Loess Smooth"), 
              linetype = "dashed", size = 1, se = FALSE) +
  
  # Manual color scale to assign specific colors to the identifiers
  scale_color_manual(name = "Model Fit", 
                     values = c("Linear Fit" = "darkred", 
                                "Loess Smooth" = "blue")) +
  
  theme_minimal() +
  labs(title = "Rent Price vs. Living Area",
       x = "Area (sqm)", 
       y = "Rent") +
  
  # Legend position
  theme(legend.position = "top")

    # 2. Rent vs. Year of Construction (Scatter with Trend Line)
    # The blue line helps you see if the relationship is linear or curved (U-shaped)
    plot_trend <- ggplot(rent99, aes(x = yearc, y = rent)) +
      geom_point(alpha = 0.4, color = "gray40") + # The dots
      geom_smooth(method = "loess", formula = y ~ x, color = "blue", size = 1) + # The smooth trend line
      theme_minimal() +
      labs(title = "Rent Price vs. Year Built", 
           subtitle = "Are newer buildings more expensive?",
           x = "Year of Construction", 
           y = "Rent")


    plot(plot_trend)
```

RENT vs AREA

- **Linearity**: The linear fit (Red) overlaps almost perfectly with the flexible smooth line (Blue)
- **Heteroscedasticity**: The spread of residuals is not constant across the size range
- **Suggestion**: `area` could be modeled as a linear parametric term

RENT vs YEARC

-   **Shape**: U-shaped curve indicates "Vintage" and Modern premiums.
-   **Dip**: Mid-century buildings command the lowest rents.
-   **Spread**: High variance; age alone predicts poorly


# CATEGORICAL VARIABLES | Univariate Analysis


## Categorical Variables

```{r categorical_plots, warning=FALSE, echo=FALSE, fig.height=6, fig.width=8}
# Set up a 2x2 grid
par(mfrow = c(2, 2))

# --- 1. Location ---
loc_counts <- table(rent99$location)
barplot(loc_counts, 
        main = "Location", 
        col = "steelblue", 
        names.arg = c("Avg", "Good", "Top"),
        # FIX: Multiply max height by 1.2 to give 20% extra headroom
        ylim = c(0, max(loc_counts) * 1.2)) 
text(x = 0.7 + (0:(length(loc_counts)-1))*1.2, 
     y = loc_counts, 
     labels = loc_counts, 
     pos = 3)

# --- 2. Bath ---
bath_counts <- table(rent99$bath)
barplot(bath_counts, 
        main = "Bath Quality", 
        col = "firebrick", 
        names.arg = c("Standard", "Premium"),
        # FIX: Multiply by 1.2
        ylim = c(0, max(bath_counts) * 1.2))
text(x = 0.7 + (0:(length(bath_counts)-1))*1.2, 
     y = bath_counts, 
     labels = bath_counts, 
     pos = 3)

# --- 3. Kitchen ---
kit_counts <- table(rent99$kitchen)
barplot(kit_counts, 
        main = "Kitchen Quality", 
        col = "forestgreen", 
        names.arg = c("Standard", "Premium"),
        # FIX: Multiply by 1.2
        ylim = c(0, max(kit_counts) * 1.2))
text(x = 0.7 + (0:(length(kit_counts)-1))*1.2, 
     y = kit_counts, 
     labels = kit_counts, 
     pos = 3)

# --- 4. Central Heating ---
heat_counts <- table(rent99$cheating)
barplot(heat_counts, 
        main = "Central Heating", 
        col = "orange", 
        names.arg = c("No", "Yes"),
        # FIX: Multiply by 1.2
        ylim = c(0, max(heat_counts) * 1.2))
text(x = 0.7 + (0:(length(heat_counts)-1))*1.2, 
     y = heat_counts, 
     labels = heat_counts, 
     pos = 3)

# Reset layout
par(mfrow = c(1, 1))
```



## Categorical Predictors: Imbalance Warning!

-   **Uneven Distribution**: Possible significant imbalance observed across all categorical variables.
-   **Location**: "Top" location (Cat 3) is rare ($N=78$ vs. $1,794$ for Average).
-   **Amenities**: Premium Kitchens and Baths represent \<6% of the data.
-   **Impact**: Rare classes effectively shrink the sample size for those specific coefficients, leading to higher uncertainty (Standard Error)

## Imbalance ratio IR {.smaller}
-  Location: $$IR = \frac{N_{majority}}{N_{minority}}=\frac{1794}{78} \approx23$$
-  Bath: $$IR = {2891 \over 191} \approx 15$$
-  Kitchen: $$ IR = {2951 \over 131} \approx 23 $$
-  Heating: $$IR = {2761 \over 321} \approx 9 $$

None of there ratios its extreme, meaning that the dataset is not severely imbalanced.

## Handling Imbalance: Methodological Choice

-   **Observation**: While "Premium" classes are rare, they are not empty.
-   **Threshold**: The absolute sample size for the smallest group ($N=78$) is sufficient for statistical inference (Central Limit Theorem).
-   **Decision**: No resampling required. We proceed with the original data.
-   **Note**: We accept that confidence intervals for "Top Location" and "Premium" amenities will naturally be wider



## Feature Engineering: Handling `district`

-   **Data Type Error**: Originally numeric, mathematically wrong for a location ID
-   **Action**: converted to a factor before modeling

```{r convert_district_factor, echo=TRUE}
rent99$district <- as.factor(rent99$district)
```

-   **High Cardinality Issue**: 336 distinct sub-districts is too granular for n $\approx$ 3,000 observations
-   **Solution**: Aggregate to 25 main administrative districts (Stadtbezirke) to ensure statistical stability

## Aggregating `district` Variable

```{r aggregate_districts, echo=TRUE}
rent99$district_main <- as.factor(ifelse(
  nchar(as.character(rent99$district)) == 3,
  substr(as.character(rent99$district), 1, 1),
  substr(as.character(rent99$district), 1, 2)
))
dist_counts <- table(rent99$district_main)
dist_counts[1:13]
dist_counts[14:25]
```




## Checking sample size per new `district_main`

```{r, warning=FALSE, fig.height=3.7, fig.align='center'}
# Barplot of observations per aggregated district
ggplot(rent99, aes(x = district_main)) +
  geom_bar(fill = "steelblue", color = "white") +
  
  # Add count labels on top of bars
  geom_text(stat='count', aes(label=..count..), vjust=-0.5, size=3) +
  
  theme_minimal() +
  labs(title = "Observations per Aggregated District",
       subtitle = "Checking for adequate sample size in the 25 new zones",
       x = "District ID (Aggregated)",
       y = "Count")
```


Every new district has a good number of observation, ranging from 25 to 280


# CATEGORICAL VARIABLES | Bivariate Analysis

## Categorical Predictors: Price Drivers {.smaller}

```{r categorical_boxplots, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6.5, fig.height=3.5, fig.align='center'}
# Setup 1x4 grid
par(mfrow = c(1, 4)) 

# 1. Location
boxplot(rent ~ location, data = rent99, 
        main = "Location", 
        col = c("#A6CEE3", "#1F78B4", "#B2DF8A"),
        ylab = "rent", xlab = "")
grid()

# 2. Heating
boxplot(rent ~ cheating, data = rent99, 
        main = "Central Heating", 
        col = c("gray90", "orange"),
        names = c("No", "Yes"), xlab = "")
grid()

# 3. Kitchen
boxplot(rent ~ kitchen, data = rent99, 
        main = "Kitchen", 
        col = c("gray90", "forestgreen"),
        names = c("Standard", "Premium"), xlab = "")
grid()

# 4. Bath
boxplot(rent ~ bath, data = rent99,
        main = "Bath", 
        col = c("gray90", "firebrick"),
        names = c("Standard", "Premium"), xlab = "")

par(mfrow = c(1, 1))
```


- *Location*: Clear stepwise price increase; significant premium for "Top" zones

- *Heating*: Strong differentiator; consistently drives higher median rents

- *Kitchen*: Positive shift in price, though the effect size is smaller

- *Bath*: Similar positive effect as kitchen, but with more variability due to fewer premium units



## Boxplot of `rent` by `district_main` {.smaller}
```{r, warning=FALSE, fig.height=3.8, fig.align='center'}
# Boxplot of rent by aggregated district, ordered by median price
ggplot(rent99, aes(x = reorder(district_main, rent, FUN = median), y = rent)) +
  
  # Boxplot
  geom_boxplot(fill = "cadetblue", outlier.alpha = 0.2) +
  
  # Mean line
  geom_hline(yintercept = mean(rent99$rent), color = "red", linetype = "dashed") +
  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 9)) + 
  
  labs(title = "Rent by Aggregated District",
       subtitle = "Sorted by Median Price of Each District",
       x = "District ID",
       y = "Rent")

```

- **Validation**: The sorted plot validates the aggregation strategy, revealing a clear price hierarchy from affordable to premium zones.

- **Modeling**: Significant median variation could confirm predictive power, while consistent spreads indicate stable variance for the regression.


## Correlation Analysis | Numeric Predictors

```{r correlation_matrix, warning=FALSE, message=FALSE, echo=FALSE, fig.width=3, fig.height=3, fig.align='center'}
library(corrplot)

# 1. Select numeric vars + location (treated as numeric ordinal)
numeric_vars <- rent99[, c("rent", "area", "yearc")]
numeric_vars$location <- as.numeric(rent99$location) 

# 2. Calculate Correlation
cor_matrix <- cor(numeric_vars, use = "complete.obs")

# 3. Plot
corrplot(cor_matrix, method = "color", 
         type = "upper", 
         addCoef.col = "black", # Add numbers
         tl.col = "black", 
         diag = FALSE,
         mar = c(0,0,1,0))
```


-   `area` is the strongest predictor of `rent` (0.58), confirming size drives relative price

-   `yearc` (0.17) and `location` (0.13) show weak linear links to `rent`, suggesting non-linear effects

  -   The negative correlation between `area` and `yearc` (-0.23) indicates newer apartments tend to be smaller
  - Predictor correlations are low (\< 0.3), confirming no multicollinearity.

## Area vs yearc {.smaller}

```{r area_vs_yearc_scatter, warning=FALSE, message=FALSE, echo=FALSE, fig.width=5, fig.height=3, fig.align='center'}
library(ggplot2)
ggplot(rent99, aes(x = yearc, y = area)) +
  # Points with transparency
  geom_point(alpha = 0.3, color = "purple") +
  
  # Linear Regression Line
  geom_smooth(method = "lm", aes(color = "Linear Fit"), 
              size = 1, se = FALSE) +
  
  # Loess Line
  geom_smooth(method = "loess", aes(color = "Loess Smooth"), 
              linetype = "dashed", size = 1, se = FALSE) +
  
  # Manual color scale to assign specific colors to the identifiers
  scale_color_manual(name = "Model Fit", 
                     values = c("Linear Fit" = "darkred", 
                                "Loess Smooth" = "blue")) +
  
  theme_minimal() +
  labs(title = "Area vs. Year of Construction",
       x = "Year of Construction", 
       y = "Area (sqm)") +
  
  # Legend position
  theme(legend.position = "top")
```

- **Negative Trend**: Newer buildings tend to be smaller, confirming the negative correlation (-0.23)
- **Non-Linearity**: The loess curve shows a more complex relationship, suggesting size reductions accelerated in recent decades
- **Modeling Implication**: Consider potential interaction or non-linear terms when including both variables in the model


# MODELING



## Why this specific dataset requires a GAM
- **Non-Linear Relationships**
  - EDA revealed U-shaped trends (e.g., yearc) that linear models cannot capture.
- **Flexibility**
  - GAMs allow for smooth functions, adapting to complex patterns without overfitting.
- **Interpretability**
  - GAMs maintain interpretability by isolating effects of individual predictors.


## GAM baseline model {.smaller}

We begin with a **fully linear** specification (using gam without smoothing functions) to establish a *benchmark*.


```{r gam_model, warning=FALSE, message=FALSE, echo=TRUE}

library(mgcv)
model1 <- gam(rent ~ area + yearc + location +
              kitchen + cheating + bath + district_main,
              family = gaussian(), data = rent99)
summary(model1)
```

Observing the **p-values** of the district variable, we can see that they are **not significant**, indicating that the variable does not contribute to the model. We can therefore consider *removing it* in future models.

## Baseline Model Diagnostics {.smaller}

If the residuals show a pattern, we know the linear assumption is insufficient.

```{r gam_diagnostics, warning=FALSE, fig.width=8, fig.height=3}
# Setup a 1x2 plotting area to check both continuous variables
par(mfrow = c(1, 2)) 

# --- Check AREA ---
# 1. Plot Area vs Residuals
plot(rent99$area, residuals(model1), 
     col = "gray", pch = 20,
     xlab = "Area (sqm)", ylab = "Residuals",
     main = "Residuals vs Area")
abline(h = 0, col = "red", lty = 2)
# 2. Add a smoothing line (Loess) to help your eye see the trend
lines(lowess(rent99$area, residuals(model1)), col = "blue", lwd = 2)

# --- Check YEARC ---
# 1. Plot Year vs Residuals
plot(rent99$yearc, residuals(model1), 
     col = "gray", pch = 20,
     xlab = "Year Constructed", ylab = "Residuals",
     main = "Residuals vs Year")
abline(h = 0, col = "red", lty = 2)
# 2. Add a smoothing line
lines(lowess(rent99$yearc, residuals(model1)), col = "blue", lwd = 2)

# Reset plotting area
par(mfrow = c(1, 1))
```

We can see a **slight pattern** in the residuals indicating that the linear assumption may not be sufficient.

$\implies$ model these variables with *smoothing functions* in the next steps.

## GAM with Smoothing Functions {.smaller}

```{r gam_model_simple, echo=TRUE}
model2 <- gam(rent ~ s(area) + s(yearc) + location + 
                kitchen + cheating + bath, 
              family = gaussian(), data = rent99)

summary(model2)
model2$sp
```
- `s(area)` and `s(yearc)` are **highly significant** ($p < 2e-16$), confirming that those variables are still important for this model.
- The *edf* for `area` is 7.63, which is substantially higher than 1 $\to$  highly non-linear and complex relationship between `area` and `rent`. 
- `yearc` has an edf of 4.97, also confirming non-linearity, though slightly less complex than area.
- The low smoothing parameter for `area` ($\approx 0.06$) is consistent with this high edf, as it imposes very little penalty on the curve's complexity.

## Model 2 Diagnostics 

```{r res, warning=FALSE, fig.width=8, fig.height=3}
# Setup a 1x2 plotting area to check both continuous variables
par(mfrow = c(1, 2)) 

# --- Check AREA ---
# 1. Plot Area vs Residuals
plot(rent99$area, residuals(model2), 
     col = "gray", pch = 20,
     xlab = "Area (sqm)", ylab = "Residuals",
     main = "Residuals vs Area")
abline(h = 0, col = "red", lty = 2)
# 2. Add a smoothing line (Loess) to help your eye see the trend
lines(lowess(rent99$area, residuals(model2)), col = "blue", lwd = 2)

# --- Check YEARC ---
# 1. Plot Year vs Residuals
plot(rent99$yearc, residuals(model2), 
     col = "gray", pch = 20,
     xlab = "Year Constructed", ylab = "Residuals",
     main = "Residuals vs Year")
abline(h = 0, col = "red", lty = 2)
# 2. Add a smoothing line
lines(lowess(rent99$yearc, residuals(model2)), col = "blue", lwd = 2)

# Reset plotting area
par(mfrow = c(1, 1))
```

- The residual plots show **no clear patterns** for either `area` or `yearc`, indicating that the smoothing functions have effectively captured the non-linear relationships. 
- The *residuals are randomly scattered around zero*, but in the first graph we can see the "cone" shape, suggesting for heteroscedasticity.

## Visual interpretation of the spline effect

```{r}
par(mfrow = c(1, 2))

# shift = intercept (baseline price)
plot(model2, select = 1,      # 1 = s(area)
     shade = TRUE,                 # Add confidence intervals
     main = "Effect of Area on Rent (in Euros)",
     ylab = "Predicted Rent Contribution (€)",
     xlab = "Area (sqm)")

# shift = intercept (baseline price)
plot(model2, select = 2,      # 2 = s(yearc)
     shade = TRUE,                 # Add confidence intervals
     main = "Effect of Yearc on Rent (in Euros)",
     ylab = "Predicted Rent Contribution (€)",
     xlab = "Yearc")

par(mfrow = c(1, 1))
```


- Rent increases linearly with size for standard apartments (20–100 sqm). Above 120 sqm, the **curve steepens**, indicating a 'luxury premium' where the cost of extra space rises
- Rent is stable for buildings constructed before 1960. After 1960, prices rise steadily, showing a clear premium for modern construction.


## GAM without `bath` {.smaller}

```{r gam_model_final, echo=TRUE}
model3 <- gam(rent ~ s(yearc) + s(area) + location + 
                kitchen + cheating, 
              family = gaussian(), data = rent99)

summary(model3)
```

## Comparing Model 2 vs Model 3

Model 2 (with bath) against Model 3 (without) performs better on every meaningful metric:

- The variable is **highly significant**($p = 2.07 \times 10^{-6}$), proving that bathrooms strongly influence rent prices.

- Model 2 has a **lower AIC** (39,080 vs. 39,101). A drop of ~20 points is strong evidence that the model is better.

- The prediction **error score** (GCV) is **lower** in Model 2 (18,801) compared to Model 3 (18,927).

- The **Adjusted** $\mathbf R^2$ is **higher** in Model 2 (0.512), meaning it explains more of the data's variability.

$\implies$ Removing bath makes the model significantly *worse*. It should be retained.


## Gaussian Model with Log Link

Previously, we observed that **rent is right-skewed**.
To avoid the interpretability issues associated with log-transforming the response variable, we will instead model rent directly. 

By specifying a **log link function** within the Gaussian family, we can handle the skewness and enforce positive fitted values while preserving the original scale of the data.

```{r, echo=TRUE}
model_gauss <- gam(
  rent ~ s(area) + s(yearc) + location + bath + kitchen + cheating ,
  family = gaussian(link = "log"),
  data = rent99
)
summary(model_gauss)
```
## Gaussian Model Diagnostics

```{r, echo=TRUE}
par(mfrow=c(2,2))
gam.check(model_gauss)
```

- **Normality**: The Q-Q plot and histogram suggest that the residuals follow an approximate normal distribution, with only minor deviations in the tails.
- **Homoscedasticity**: This plot displays a distinct "cone" shape.
The spread of the residuals expands significantly as the predicted rent increase.
This indicates that the *variance is not constant* but rather increases with the mean (**critical violation of the Gaussian assumptions**).


## Gamma Model

Although the Gaussian model with a log link provides a reasonable fit, the Gamma family is theoretically superior for modeling rent. 

**Gamma distribution is naturally defined for positive, right-skewed data and accounts for heteroscedasticity**: this aligns better with economic reality, as higher rents typically exhibit greater variability.

```{r, echo=TRUE}
model_gamma <- gam(
  rent ~ s(area) + s(yearc) + location + cheating + bath + kitchen,
  family = Gamma(link = "log"),
  data = rent99
)
summary(model_gamma)

model_gamma$sp
```
## Visual interpretation of the spline effect on Gamma model

```{r}
par(mfrow = c(1, 2))

# shift = intercept (baseline price)
# trans = exp (convert log to euros)
plot(model_gamma, select = 1,      # 1 = s(area)
     shade = TRUE,                 # Add confidence intervals
     shift = coef(model_gamma)[1], # Shift by the intercept
     trans = exp,                  # Transform log -> Real Money
     main = "Effect of Area on Rent (in Euros)",
     ylab = "Predicted Rent Contribution (€)",
     xlab = "Area (sqm)")

# shift = intercept (baseline price)
# trans = exp (convert log to euros)
plot(model_gamma, select = 2,      # 2 = s(yearc)
     shade = TRUE,                 # Add confidence intervals
     shift = coef(model_gamma)[1], # Shift by the intercept
     trans = exp,                  # Transform log -> Real Money
     main = "Effect of Yearc on Rent (in Euros)",
     ylab = "Predicted Rent Contribution (€)",
     xlab = "Yearc")

par(mfrow = c(1, 1))
```



## Gamma Model Diagnostics

```{r, echo=TRUE}
par(mfrow=c(2,2))
gam.check(model_gamma)
```

The diagnostic plots confirm a strong model fit:

- **Q-Q plot** shows *no significant deviation* from the theoretical quantiles.
- **Residuals** scatter is *uniform and centered* around zero, *without patterns*, and we can see homoscedasticity.



## Model Comparison: AIC

```{r, echo=FALSE}

results <- AIC(model1, model2, model3, model_gauss, model_gamma)

results$BIC <- BIC(model1, model2, model3, model_gauss, model_gamma)$BIC


results$Dev_Expl <- c(summary(model1)$dev.expl, summary(model2)$dev.expl, summary(model3)$dev.expl, 
                      summary(model_gauss)$dev.expl, summary(model_gamma)$dev.expl)
print(results)
```

- The Gamma model achieves the **lowest AIC** (38,501) and **BIC** (38,614), indicating the best fit among all considered models. 
- Although its deviance explained (51.2%) is **slightly lower** than the Gaussian log-link model (53.1%), the substantial drop in information criteria confirms that the Gamma distribution is statistically more appropriate for modeling rent data, effectively capturing its positive skewness and heteroscedasticity.


## Conclusions
$\implies$ **`model_gamma` offers a good trade-off between complexity and fit while respecting the physical and economic nature of the data.**

**Limitations**: 

- The model explains 51.2% of the variance, meaning nearly half of the factors driving rent prices are unobserved. 

- To improve accuracy, future models would need data currently missing from this dataset, such as for example renovation status, energy efficiency ratings, or specific neighborhood quality.


# Thank you <br> for your attention

